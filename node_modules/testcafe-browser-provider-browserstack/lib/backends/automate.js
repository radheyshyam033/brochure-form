"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("util");
const jimp_1 = __importDefault(require("jimp"));
const base_1 = __importDefault(require("./base"));
const request_api_1 = __importDefault(require("../utils/request-api"));
const create_browserstack_status_1 = __importDefault(require("../utils/create-browserstack-status"));
const get_api_polling_interval_1 = __importDefault(require("../utils/get-api-polling-interval"));
const ERROR_MESSAGES = __importStar(require("../templates/error-messages"));
const API_POLLING_INTERVAL = get_api_polling_interval_1.default();
const BROWSERSTACK_API_PATHS = {
    browserList: {
        url: 'https://api.browserstack.com/automate/browsers.json'
    },
    newSession: {
        url: 'https://hub-cloud.browserstack.com/wd/hub/session',
        method: 'POST'
    },
    openUrl: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/url`,
        method: 'POST'
    }),
    getWindowSize: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/window/current/size`
    }),
    setWindowSize: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/window/current/size`,
        method: 'POST'
    }),
    maximizeWindow: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/window/current/maximize`,
        method: 'POST'
    }),
    getUrl: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/url`
    }),
    deleteSession: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}`,
        method: 'DELETE'
    }),
    screenshot: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/screenshot`
    }),
    getStatus: id => ({
        url: `https://api.browserstack.com/automate/sessions/${id}.json`
    }),
    setStatus: id => ({
        url: `https://api.browserstack.com/automate/sessions/${id}.json`,
        method: 'PUT'
    })
};
function requestApi(path, params) {
    return request_api_1.default(path, params)
        .then(response => {
        if (response.status) {
            throw new Error(ERROR_MESSAGES.REMOTE_API_REQUEST_FAILED({
                status: response.status,
                apiResponse: response.value && response.value.message || util_1.inspect(response)
            }));
        }
        return response;
    });
}
function getCorrectedSize(currentClientAreaSize, currentWindowSize, requestedSize) {
    var horizontalChrome = currentWindowSize.width - currentClientAreaSize.width;
    var verticalChrome = currentWindowSize.height - currentClientAreaSize.height;
    return {
        width: requestedSize.width + horizontalChrome,
        height: requestedSize.height + verticalChrome
    };
}
class AutomateBackend extends base_1.default {
    constructor(...args) {
        super(...args);
        this.sessions = {};
    }
    static _ensureSessionId(sessionInfo) {
        const sessionData = sessionInfo.value || {};
        const sessionCapabilities = sessionData.capabilities || {};
        sessionInfo.sessionId = sessionInfo.sessionId ||
            sessionData.sessionId ||
            sessionData['webdriver.remote.sessionid'] ||
            sessionCapabilities['webdriver.remote.sessionid'];
        if (!sessionInfo.sessionId) {
            throw new Error(ERROR_MESSAGES.SESSION_ID_NOT_FOUND({
                sessionInfoDump: util_1.inspect(sessionInfo)
            }));
        }
    }
    async _requestSessionUrl(id) {
        var sessionInfo = await request_api_1.default(BROWSERSTACK_API_PATHS.getStatus(this.sessions[id].sessionId));
        return sessionInfo['automation_session']['browser_url'];
    }
    async _requestCurrentWindowSize(id) {
        var currentWindowSizeData = await requestApi(BROWSERSTACK_API_PATHS.getWindowSize(this.sessions[id].sessionId));
        return {
            width: currentWindowSizeData.value.width,
            height: currentWindowSizeData.value.height
        };
    }
    async getBrowsersList() {
        var platformsInfo = await request_api_1.default(BROWSERSTACK_API_PATHS.browserList);
        return platformsInfo.reverse();
    }
    getSessionUrl(id) {
        return this.sessions[id] ? this.sessions[id].sessionUrl : '';
    }
    async openBrowser(id, pageUrl, capabilities) {
        var { localIdentifier, local } = capabilities, restCapabilities = __rest(capabilities, ["localIdentifier", "local"]);
        capabilities = Object.assign({ 'browserstack.localIdentifier': localIdentifier, 'browserstack.local': local }, restCapabilities);
        this.sessions[id] = await requestApi(BROWSERSTACK_API_PATHS.newSession, {
            body: { desiredCapabilities: capabilities },
            executeImmediately: true
        });
        AutomateBackend._ensureSessionId(this.sessions[id]);
        this.sessions[id].sessionUrl = await this._requestSessionUrl(id);
        var sessionId = this.sessions[id].sessionId;
        this.sessions[id].interval = setInterval(() => requestApi(BROWSERSTACK_API_PATHS.getUrl(sessionId), { executeImmediately: true }), API_POLLING_INTERVAL);
        await requestApi(BROWSERSTACK_API_PATHS.openUrl(sessionId), { body: { url: pageUrl } });
    }
    async closeBrowser(id) {
        const session = this.sessions[id];
        if (!session)
            return;
        clearInterval(session.interval);
        delete this.sessions[id];
        // Delete session whose sessionId is created
        if (session.sessionId && session.sessionId !== '')
            await requestApi(BROWSERSTACK_API_PATHS.deleteSession(session.sessionId));
    }
    async takeScreenshot(id, screenshotPath) {
        var base64Data = await requestApi(BROWSERSTACK_API_PATHS.screenshot(this.sessions[id].sessionId));
        var buffer = Buffer.from(base64Data.value, 'base64');
        const image = await jimp_1.default.read(buffer);
        await image.writeAsync(screenshotPath);
    }
    async resizeWindow(id, width, height, currentWidth, currentHeight) {
        var sessionId = this.sessions[id].sessionId;
        var currentWindowSize = await this._requestCurrentWindowSize(id);
        var currentClientAreaSize = { width: currentWidth, height: currentHeight };
        var requestedSize = { width, height };
        var correctedSize = getCorrectedSize(currentClientAreaSize, currentWindowSize, requestedSize);
        await requestApi(BROWSERSTACK_API_PATHS.setWindowSize(sessionId), { body: correctedSize });
    }
    async maximizeWindow(id) {
        await requestApi(BROWSERSTACK_API_PATHS.maximizeWindow(this.sessions[id].sessionId));
    }
    async reportJobResult(id, jobResult, jobData, possibleResults) {
        var sessionId = this.sessions[id].sessionId;
        var jobStatus = create_browserstack_status_1.default(jobResult, jobData, possibleResults);
        await request_api_1.default(BROWSERSTACK_API_PATHS.setStatus(sessionId), { body: jobStatus });
    }
}
exports.default = AutomateBackend;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0b21hdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYmFja2VuZHMvYXV0b21hdGUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwrQkFBK0I7QUFDL0IsZ0RBQXdCO0FBQ3hCLGtEQUFpQztBQUNqQyx1RUFBa0Q7QUFDbEQscUdBQTJFO0FBQzNFLGlHQUFzRTtBQUN0RSw0RUFBOEQ7QUFHOUQsTUFBTSxvQkFBb0IsR0FBRyxrQ0FBcUIsRUFBRSxDQUFDO0FBRXJELE1BQU0sc0JBQXNCLEdBQUc7SUFDM0IsV0FBVyxFQUFFO1FBQ1QsR0FBRyxFQUFFLHFEQUFxRDtLQUM3RDtJQUVELFVBQVUsRUFBRTtRQUNSLEdBQUcsRUFBSyxtREFBbUQ7UUFDM0QsTUFBTSxFQUFFLE1BQU07S0FDakI7SUFFRCxPQUFPLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ1osR0FBRyxFQUFLLHFEQUFxRCxFQUFFLE1BQU07UUFDckUsTUFBTSxFQUFFLE1BQU07S0FDakIsQ0FBQztJQUVGLGFBQWEsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbEIsR0FBRyxFQUFFLHFEQUFxRCxFQUFFLHNCQUFzQjtLQUNyRixDQUFDO0lBRUYsYUFBYSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNsQixHQUFHLEVBQUsscURBQXFELEVBQUUsc0JBQXNCO1FBQ3JGLE1BQU0sRUFBRSxNQUFNO0tBQ2pCLENBQUM7SUFFRixjQUFjLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ25CLEdBQUcsRUFBSyxxREFBcUQsRUFBRSwwQkFBMEI7UUFDekYsTUFBTSxFQUFFLE1BQU07S0FDakIsQ0FBQztJQUVGLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDWCxHQUFHLEVBQUUscURBQXFELEVBQUUsTUFBTTtLQUNyRSxDQUFD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QUFFLEVBQUU7UUFDcEIsTUFBTSxVQUFVLENBQUMsc0JBQXNCLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUN6RixDQUFDO0lBRUQsS0FBSyxDQUFDLGVBQWUsQ0FBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxlQUFlO1FBQzFELElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQzVDLElBQUksU0FBUyxHQUFHLG9DQUF3QixDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFFOUUsTUFBTSxxQkFBYyxDQUFDLHNCQUFzQixDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBQzNGLENBQUM7Q0FDSjtBQXRIRCxrQ0FzSEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpbnNwZWN0IH0gZnJvbSAndXRpbCc7XG5pbXBvcnQgamltcCBmcm9tICdqaW1wJztcbmltcG9ydCBCYXNlQmFja2VuZCBmcm9tICcuL2Jhc2UnO1xuaW1wb3J0IHJlcXVlc3RBcGlCYXNlIGZyb20gJy4uL3V0aWxzL3JlcXVlc3QtYXBpJztcbmltcG9ydCBjcmVhdGVCcm93c2Vyc3RhY2tTdGF0dXMgZnJvbSAnLi4vdXRpbHMvY3JlYXRlLWJyb3dzZXJzdGFjay1zdGF0dXMnO1xuaW1wb3J0IGdldEFQSVBvbGxpbmdJbnRlcnZhbCBmcm9tICcuLi91dGlscy9nZXQtYXBpLXBvbGxpbmctaW50ZXJ2YWwnO1xuaW1wb3J0ICogYXMgRVJST1JfTUVTU0FHRVMgZnJvbSAnLi4vdGVtcGxhdGVzL2Vycm9yLW1lc3NhZ2VzJztcblxuXG5jb25zdCBBUElfUE9MTElOR19JTlRFUlZBTCA9IGdldEFQSVBvbGxpbmdJbnRlcnZhbCgpO1xuXG5jb25zdCBCUk9XU0VSU1RBQ0tfQVBJX1BBVEhTID0ge1xuICAgIGJyb3dzZXJMaXN0OiB7XG4gICAgICAgIHVybDogJ2h0dHBzOi8vYXBpLmJyb3dzZXJzdGFjay5jb20vYXV0b21hdGUvYnJvd3NlcnMuanNvbidcbiAgICB9LFxuXG4gICAgbmV3U2Vzc2lvbjoge1xuICAgICAgICB1cmw6ICAgICdodHRwczovL2h1Yi1jbG91ZC5icm93c2Vyc3RhY2suY29tL3dkL2h1Yi9zZXNzaW9uJyxcbiAgICAgICAgbWV0aG9kOiAnUE9TVCdcbiAgICB9LFxuXG4gICAgb3BlblVybDogaWQgPT4gKHtcbiAgICAgICAgdXJsOiAgICBgaHR0cHM6Ly9odWItY2xvdWQuYnJvd3NlcnN0YWNrLmNvbS93ZC9odWIvc2Vzc2lvbi8ke2lkfS91cmxgLFxuICAgICAgICBtZXRob2Q6ICdQT1NUJ1xuICAgIH0pLFxuXG4gICAgZ2V0V2luZG93U2l6ZTogaWQgPT4gKHtcbiAgICAgICAgdXJsOiBgaHR0cHM6Ly9odWItY2xvdWQuYnJvd3NlcnN0YWNrLmNvbS93ZC9odWIvc2Vzc2lvbi8ke2lkfS93aW5kb3cvY3VycmVudC9zaXplYFxuICAgIH0pLFxuXG4gICAgc2V0V2luZG93U2l6ZTogaWQgPT4gKHtcbiAgICAgICAgdXJsOiAgICBgaHR0cHM6Ly9odWItY2xvdWQuYnJvd3NlcnN0YWNrLmNvbS93ZC9odWIvc2Vzc2lvbi8ke2lkfS93aW5kb3cvY3VycmVudC9zaXplYCxcbiAgICAgICAgbWV0aG9kOiAnUE9TVCdcbiAgICB9KSxcblxuICAgIG1heGltaXplV2luZG93OiBpZCA9PiAoe1xuICAgICAgICB1cmw6ICAgIGBodHRwczovL2h1Yi1jbG91ZC5icm93c2Vyc3RhY2suY29tL3dkL2h1Yi9zZXNzaW9uLyR7aWR9L3dpbmRvdy9jdXJyZW50L21heGltaXplYCxcbiAgICAgICAgbWV0aG9kOiAnUE9TVCdcbiAgICB9KSxcblxuICAgIGdldFVybDogaWQgPT4gKHtcbiAgICAgICAgdXJsOiBgaHR0cHM6Ly9odWItY2xvdWQuYnJvd3NlcnN0YWNrLmNvbS93ZC9odWIvc2Vzc2lvbi8ke2lkfS91cmxgXG4gICAgfSksXG5cbiAgICBkZWxldGVTZXNzaW9uOiBpZCA9PiAoe1xuICAgICAgICB1cmw6ICAgIGBodHRwczovL2h1Yi1jbG91ZC5icm93c2Vyc3RhY2suY29tL3dkL2h1Yi9zZXNzaW9uLyR7aWR9YCxcbiAgICAgICAgbWV0aG9kOiAnREVMRVRFJ1xuICAgIH0pLFxuXG4gICAgc2NyZWVuc2hvdDogaWQgPT4gKHtcbiAgICAgICAgdXJsOiBgaHR0cHM6Ly9odWItY2xvdWQuYnJvd3NlcnN0YWNrLmNvbS93ZC9odWIvc2Vzc2lvbi8ke2lkfS9zY3JlZW5zaG90YFxuICAgIH0pLFxuXG4gICAgZ2V0U3RhdHVzOiBpZCA9PiAoe1xuICAgICAgICB1cmw6IGBodHRwczovL2FwaS5icm93c2Vyc3RhY2suY29tL2F1dG9tYXRlL3Nlc3Npb25zLyR7aWR9Lmpzb25gXG4gICAgfSksXG5cbiAgICBzZXRTdGF0dXM6IGlkID0+ICh7XG4gICAgICAgIHVybDogICAgYGh0dHBzOi8vYXBpLmJyb3dzZXJzdGFjay5jb20vYXV0b21hdGUvc2Vzc2lvbnMvJHtpZH0uanNvbmAsXG4gICAgICAgIG1ldGhvZDogJ1BVVCdcbiAgICB9KVxufTtcblxuXG5mdW5jdGlvbiByZXF1ZXN0QXBpIChwYXRoLCBwYXJhbXMpIHtcbiAgICByZXR1cm4gcmVxdWVzdEFwaUJhc2UocGF0aCwgcGFyYW1zKVxuICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKEVSUk9SX01FU1NBR0VTLlJFTU9URV9BUElfUkVRVUVTVF9GQUlMRUQoe1xuICAgICAgICAgICAgICAgICAgICBzdGF0dXM6ICAgICAgcmVzcG9uc2Uuc3RhdHVzLFxuICAgICAgICAgICAgICAgICAgICBhcGlSZXNwb25zZTogcmVzcG9uc2UudmFsdWUgJiYgcmVzcG9uc2UudmFsdWUubWVzc2FnZSB8fCBpbnNwZWN0KHJlc3BvbnNlKVxuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgICAgICB9KTtcbn1cblxuZnVuY3Rpb24gZ2V0Q29ycmVjdGVkU2l6ZSAoY3VycmVudENsaWVudEFyZWFTaXplLCBjdXJyZW50V2luZG93U2l6ZSwgcmVxdWVzdGVkU2l6ZSkge1xuICAgIHZhciBob3Jpem9udGFsQ2hyb21lID0gY3VycmVudFdpbmRvd1NpemUud2lkdGggLSBjdXJyZW50Q2xpZW50QXJlYVNpemUud2lkdGg7XG4gICAgdmFyIHZlcnRpY2FsQ2hyb21lICAgPSBjdXJyZW50V2luZG93U2l6ZS5oZWlnaHQgLSBjdXJyZW50Q2xpZW50QXJlYVNpemUuaGVpZ2h0O1xuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgd2lkdGg6ICByZXF1ZXN0ZWRTaXplLndpZHRoICsgaG9yaXpvbnRhbENocm9tZSxcbiAgICAgICAgaGVpZ2h0OiByZXF1ZXN0ZWRTaXplLmhlaWdodCArIHZlcnRpY2FsQ2hyb21lXG4gICAgfTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXV0b21hdGVCYWNrZW5kIGV4dGVuZHMgQmFzZUJhY2tlbmQge1xuICAgIGNvbnN0cnVjdG9yICguLi5hcmdzKSB7XG4gICAgICAgIHN1cGVyKC4uLmFyZ3MpO1xuXG4gICAgICAgIHRoaXMuc2Vzc2lvbnMgPSB7fTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX2Vuc3VyZVNlc3Npb25JZCAoc2Vzc2lvbkluZm8pIHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbkRhdGEgICAgICAgICA9IHNlc3Npb25JbmZvLnZhbHVlIHx8IHt9O1xuICAgICAgICBjb25zdCBzZXNzaW9uQ2FwYWJpbGl0aWVzID0gc2Vzc2lvbkRhdGEuY2FwYWJpbGl0aWVzIHx8IHt9O1xuXG4gICAgICAgIHNlc3Npb25JbmZvLnNlc3Npb25JZCA9IHNlc3Npb25JbmZvLnNlc3Npb25JZCB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uRGF0YS5zZXNzaW9uSWQgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbkRhdGFbJ3dlYmRyaXZlci5yZW1vdGUuc2Vzc2lvbmlkJ10gfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbkNhcGFiaWxpdGllc1snd2ViZHJpdmVyLnJlbW90ZS5zZXNzaW9uaWQnXTtcblxuICAgICAgICBpZiAoIXNlc3Npb25JbmZvLnNlc3Npb25JZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKEVSUk9SX01FU1NBR0VTLlNFU1NJT05fSURfTk9UX0ZPVU5EKHtcbiAgICAgICAgICAgICAgICBzZXNzaW9uSW5mb0R1bXA6IGluc3BlY3Qoc2Vzc2lvbkluZm8pXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBfcmVxdWVzdFNlc3Npb25VcmwgKGlkKSB7XG4gICAgICAgIHZhciBzZXNzaW9uSW5mbyA9IGF3YWl0IHJlcXVlc3RBcGlCYXNlKEJST1dTRVJTVEFDS19BUElfUEFUSFMuZ2V0U3RhdHVzKHRoaXMuc2Vzc2lvbnNbaWRdLnNlc3Npb25JZCkpO1xuXG4gICAgICAgIHJldHVybiBzZXNzaW9uSW5mb1snYXV0b21hdGlvbl9zZXNzaW9uJ11bJ2Jyb3dzZXJfdXJsJ107XG4gICAgfVxuXG4gICAgYXN5bmMgX3JlcXVlc3RDdXJyZW50V2luZG93U2l6ZSAoaWQpIHtcbiAgICAgICAgdmFyIGN1cnJlbnRXaW5kb3dTaXplRGF0YSA9IGF3YWl0IHJlcXVlc3RBcGkoQlJPV1NFUlNUQUNLX0FQSV9QQVRIUy5nZXRXaW5kb3dTaXplKHRoaXMuc2Vzc2lvbnNbaWRdLnNlc3Npb25JZCkpO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB3aWR0aDogIGN1cnJlbnRXaW5kb3dTaXplRGF0YS52YWx1ZS53aWR0aCxcbiAgICAgICAgICAgIGhlaWdodDogY3VycmVudFdpbmRvd1NpemVEYXRhLnZhbHVlLmhlaWdodFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGFzeW5jIGdldEJyb3dzZXJzTGlzdCAoKSB7XG4gICAgICAgIHZhciBwbGF0Zm9ybXNJbmZvID0gYXdhaXQgcmVxdWVzdEFwaUJhc2UoQlJPV1NFUlNUQUNLX0FQSV9QQVRIUy5icm93c2VyTGlzdCk7XG5cbiAgICAgICAgcmV0dXJuIHBsYXRmb3Jtc0luZm8ucmV2ZXJzZSgpO1xuICAgIH1cblxuICAgIGdldFNlc3Npb25VcmwgKGlkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNlc3Npb25zW2lkXSA/IHRoaXMuc2Vzc2lvbnNbaWRdLnNlc3Npb25VcmwgOiAnJztcbiAgICB9XG5cbiAgICBhc3luYyBvcGVuQnJvd3NlciAoaWQsIHBhZ2VVcmwsIGNhcGFiaWxpdGllcykge1xuICAgICAgICB2YXIgeyBsb2NhbElkZW50aWZpZXIsIGxvY2FsLCAuLi5yZXN0Q2FwYWJpbGl0aWVzIH0gPSBjYXBhYmlsaXRpZXM7XG5cbiAgICAgICAgY2FwYWJpbGl0aWVzID0ge1xuICAgICAgICAgICAgJ2Jyb3dzZXJzdGFjay5sb2NhbElkZW50aWZpZXInOiBsb2NhbElkZW50aWZpZXIsXG4gICAgICAgICAgICAnYnJvd3NlcnN0YWNrLmxvY2FsJzogICAgICAgICAgIGxvY2FsLFxuICAgICAgICAgICAgLi4ucmVzdENhcGFiaWxpdGllc1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuc2Vzc2lvbnNbaWRdID0gYXdhaXQgcmVxdWVzdEFwaShCUk9XU0VSU1RBQ0tfQVBJX1BBVEhTLm5ld1Nlc3Npb24sIHtcbiAgICAgICAgICAgIGJvZHk6IHsgZGVzaXJlZENhcGFiaWxpdGllczogY2FwYWJpbGl0aWVzIH0sXG5cbiAgICAgICAgICAgIGV4ZWN1dGVJbW1lZGlhdGVseTogdHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICBBdXRvbWF0ZUJhY2tlbmQuX2Vuc3VyZVNlc3Npb25JZCh0aGlzLnNlc3Npb25zW2lkXSk7XG5cbiAgICAgICAgdGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvblVybCA9IGF3YWl0IHRoaXMuX3JlcXVlc3RTZXNzaW9uVXJsKGlkKTtcblxuICAgICAgICB2YXIgc2Vzc2lvbklkID0gdGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvbklkO1xuXG4gICAgICAgIHRoaXMuc2Vzc2lvbnNbaWRdLmludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gcmVxdWVzdEFwaShCUk9XU0VSU1RBQ0tfQVBJX1BBVEhTLmdldFVybChzZXNzaW9uSWQpLCB7IGV4ZWN1dGVJbW1lZGlhdGVseTogdHJ1ZSB9KSwgQVBJX1BPTExJTkdfSU5URVJWQUwpO1xuXG4gICAgICAgIGF3YWl0IHJlcXVlc3RBcGkoQlJPV1NFUlNUQUNLX0FQSV9QQVRIUy5vcGVuVXJsKHNlc3Npb25JZCksIHsgYm9keTogeyB1cmw6IHBhZ2VVcmwgfSB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBjbG9zZUJyb3dzZXIgKGlkKSB7XG4gICAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zW2lkXTtcblxuICAgICAgICBpZiAoIXNlc3Npb24pXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgY2xlYXJJbnRlcnZhbChzZXNzaW9uLmludGVydmFsKTtcblxuICAgICAgICBkZWxldGUgdGhpcy5zZXNzaW9uc1tpZF07XG5cbiAgICAgICAgLy8gRGVsZXRlIHNlc3Npb24gd2hvc2Ugc2Vzc2lvbklkIGlzIGNyZWF0ZWRcbiAgICAgICAgaWYgKHNlc3Npb24uc2Vzc2lvbklkICYmIHNlc3Npb24uc2Vzc2lvbklkICE9PSAnJylcbiAgICAgICAgICAgIGF3YWl0IHJlcXVlc3RBcGkoQlJPV1NFUlNUQUNLX0FQSV9QQVRIUy5kZWxldGVTZXNzaW9uKHNlc3Npb24uc2Vzc2lvbklkKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgdGFrZVNjcmVlbnNob3QgKGlkLCBzY3JlZW5zaG90UGF0aCkge1xuICAgICAgICB2YXIgYmFzZTY0RGF0YSA9IGF3YWl0IHJlcXVlc3RBcGkoQlJPV1NFUlNUQUNLX0FQSV9QQVRIUy5zY3JlZW5zaG90KHRoaXMuc2Vzc2lvbnNbaWRdLnNlc3Npb25JZCkpO1xuICAgICAgICB2YXIgYnVmZmVyICAgICA9IEJ1ZmZlci5mcm9tKGJhc2U2NERhdGEudmFsdWUsICdiYXNlNjQnKTtcblxuICAgICAgICBjb25zdCBpbWFnZSA9IGF3YWl0IGppbXAucmVhZChidWZmZXIpO1xuXG4gICAgICAgIGF3YWl0IGltYWdlLndyaXRlQXN5bmMoc2NyZWVuc2hvdFBhdGgpO1xuICAgIH1cblxuICAgIGFzeW5jIHJlc2l6ZVdpbmRvdyAoaWQsIHdpZHRoLCBoZWlnaHQsIGN1cnJlbnRXaWR0aCwgY3VycmVudEhlaWdodCkge1xuICAgICAgICB2YXIgc2Vzc2lvbklkICAgICAgICAgICAgID0gdGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvbklkO1xuICAgICAgICB2YXIgY3VycmVudFdpbmRvd1NpemUgICAgID0gYXdhaXQgdGhpcy5fcmVxdWVzdEN1cnJlbnRXaW5kb3dTaXplKGlkKTtcbiAgICAgICAgdmFyIGN1cnJlbnRDbGllbnRBcmVhU2l6ZSA9IHsgd2lkdGg6IGN1cnJlbnRXaWR0aCwgaGVpZ2h0OiBjdXJyZW50SGVpZ2h0IH07XG4gICAgICAgIHZhciByZXF1ZXN0ZWRTaXplICAgICAgICAgPSB7IHdpZHRoLCBoZWlnaHQgfTtcbiAgICAgICAgdmFyIGNvcnJlY3RlZFNpemUgICAgICAgICA9IGdldENvcnJlY3RlZFNpemUoY3VycmVudENsaWVudEFyZWFTaXplLCBjdXJyZW50V2luZG93U2l6ZSwgcmVxdWVzdGVkU2l6ZSk7XG5cbiAgICAgICAgYXdhaXQgcmVxdWVzdEFwaShCUk9XU0VSU1RBQ0tfQVBJX1BBVEhTLnNldFdpbmRvd1NpemUoc2Vzc2lvbklkKSwgeyBib2R5OiBjb3JyZWN0ZWRTaXplIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIG1heGltaXplV2luZG93IChpZCkge1xuICAgICAgICBhd2FpdCByZXF1ZXN0QXBpKEJST1dTRVJTVEFDS19BUElfUEFUSFMubWF4aW1pemVXaW5kb3codGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvbklkKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVwb3J0Sm9iUmVzdWx0IChpZCwgam9iUmVzdWx0LCBqb2JEYXRhLCBwb3NzaWJsZVJlc3VsdHMpIHtcbiAgICAgICAgdmFyIHNlc3Npb25JZCA9IHRoaXMuc2Vzc2lvbnNbaWRdLnNlc3Npb25JZDtcbiAgICAgICAgdmFyIGpvYlN0YXR1cyA9IGNyZWF0ZUJyb3dzZXJzdGFja1N0YXR1cyhqb2JSZXN1bHQsIGpvYkRhdGEsIHBvc3NpYmxlUmVzdWx0cyk7XG5cbiAgICAgICAgYXdhaXQgcmVxdWVzdEFwaUJhc2UoQlJPV1NFUlNUQUNLX0FQSV9QQVRIUy5zZXRTdGF0dXMoc2Vzc2lvbklkKSwgeyBib2R5OiBqb2JTdGF0dXMgfSk7XG4gICAgfVxufVxuIl19